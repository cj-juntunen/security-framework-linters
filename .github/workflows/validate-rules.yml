name: Validate Rules

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'rules/**'
      - '.github/workflows/validate-rules.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'rules/**'
  workflow_dispatch:

jobs:
  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML files
        run: |
          yamllint --version
          yamllint rules/semgrep/

  validate-semgrep:
    name: Validate Semgrep Rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Validate PCI DSS rules
        run: |
          semgrep --version
          semgrep --validate --config rules/semgrep/pci-dss/

      - name: Validate SOC 2 rules
        run: |
          semgrep --validate --config rules/semgrep/soc2/

      - name: Test Semgrep rules
        run: |
          semgrep --test --config rules/semgrep/

  validate-eslint:
    name: Validate ESLint Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install ESLint
        run: npm install -g eslint

      - name: Validate ESLint configurations
        run: |
          for config in rules/eslint/*/.eslintrc.json; do
            echo "Validating $config..."
            node -e "JSON.parse(require('fs').readFileSync('$config', 'utf8'))" || exit 1
          done

  validate-sonarqube:
    name: Validate SonarQube Profiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Validate XML profiles
        run: |
          for profile in rules/sonarqube/profiles/*.xml; do
            echo "Validating $profile..."
            xmllint --noout "$profile"
          done

  test-rules:
    name: Test Rules Against Sample Code
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-semgrep]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Create test directories
        run: |
          mkdir -p tests/sample-code/vulnerable
          mkdir -p tests/sample-code/secure
          mkdir -p tests/results

      - name: Create vulnerable sample code
        run: |
          # Python - Hardcoded secrets
          cat > tests/sample-code/vulnerable/secrets.py << 'EOF'
          API_KEY = "sk_live_1234567890abcdef"
          PASSWORD = "admin123"
          DB_CONNECTION = "postgresql://user:password@localhost/db"
          EOF

          # JavaScript - SQL injection
          cat > tests/sample-code/vulnerable/sql-injection.js << 'EOF'
          const query = `SELECT * FROM users WHERE id = ${userId}`;
          EOF

          # Python - Weak crypto
          cat > tests/sample-code/vulnerable/weak-crypto.py << 'EOF'
          import hashlib
          password_hash = hashlib.md5(password.encode()).hexdigest()
          EOF

      - name: Create secure sample code
        run: |
          # Python - Environment variables
          cat > tests/sample-code/secure/secrets.py << 'EOF'
          import os
          API_KEY = os.environ.get('API_KEY')
          PASSWORD = os.environ.get('DB_PASSWORD')
          EOF

          # JavaScript - Parameterized query
          cat > tests/sample-code/secure/sql-safe.js << 'EOF'
          const query = 'SELECT * FROM users WHERE id = ?';
          connection.query(query, [userId]);
          EOF

      - name: Test PCI DSS rules against vulnerable code
        run: |
          semgrep --config rules/semgrep/pci-dss/ \
            tests/sample-code/vulnerable/ \
            --json -o tests/results/pci-dss-vulnerable.json

      - name: Test SOC 2 rules against vulnerable code
        run: |
          semgrep --config rules/semgrep/soc2/ \
            tests/sample-code/vulnerable/ \
            --json -o tests/results/soc2-vulnerable.json

      - name: Verify findings
        run: |
          # Check that vulnerable code triggered findings
          PCI_FINDINGS=$(jq '.results | length' tests/results/pci-dss-vulnerable.json)
          SOC2_FINDINGS=$(jq '.results | length' tests/results/soc2-vulnerable.json)
          
          echo "PCI DSS findings: $PCI_FINDINGS"
          echo "SOC 2 findings: $SOC2_FINDINGS"
          
          if [ "$PCI_FINDINGS" -eq 0 ] && [ "$SOC2_FINDINGS" -eq 0 ]; then
            echo "Error: No findings detected in vulnerable code"
            exit 1
          fi
          
          echo "Successfully detected vulnerabilities"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: tests/results/

  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation
        run: |
          # Check that each framework has documentation
          for framework in rules/semgrep/*/; do
            if [ ! -f "$framework/README.md" ]; then
              echo "Error: Missing README.md in $framework"
              exit 1
            fi
          done
          
          # Check that root documentation exists
          for doc in README.md CONTRIBUTING.md LICENSE; do
            if [ ! -f "$doc" ]; then
              echo "Warning: Missing $doc"
            fi
          done

      - name: Validate markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-semgrep, validate-eslint, validate-sonarqube, test-rules, documentation-check]
    if: always()
    steps:
      - name: Check validation status
        run: |
          echo "Validation Summary"
          echo "=================="
          echo "YAML Validation: ${{ needs.validate-yaml.result }}"
          echo "Semgrep Validation: ${{ needs.validate-semgrep.result }}"
          echo "ESLint Validation: ${{ needs.validate-eslint.result }}"
          echo "SonarQube Validation: ${{ needs.validate-sonarqube.result }}"
          echo "Rule Testing: ${{ needs.test-rules.result }}"
          echo "Documentation: ${{ needs.documentation-check.result }}"
          
          # Fail if any job failed
          if [ "${{ needs.validate-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-semgrep.result }}" != "success" ] || \
             [ "${{ needs.validate-eslint.result }}" != "success" ] || \
             [ "${{ needs.validate-sonarqube.result }}" != "success" ] || \
             [ "${{ needs.test-rules.result }}" != "success" ]; then
            echo "One or more validation checks failed"
            exit 1
          fi
          
          echo "All validation checks passed!"
